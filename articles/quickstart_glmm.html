<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>projpred Performing variable and structure selection on Generalized Linear Multilevel Models • projpred</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="projpred Performing variable and structure selection on Generalized Linear Multilevel Models">
<meta property="og:description" content="projpred">
<meta property="og:image" content="https://mc-stan.org/projpred/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">projpred</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://mc-stan.org/rstan">rstan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/cmdstanr">cmdstanr</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstanarm">rstanarm</a>
    </li>
    <li>
      <a href="https://mc-stan.org/bayesplot">bayesplot</a>
    </li>
    <li>
      <a href="https://mc-stan.org/shinystan">shinystan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/loo">loo</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstantools">rstantools</a>
    </li>
    <li>
      <a href="https://mc-stan.org/posterior">posterior</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://mc-stan.org">Stan</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/mcmc_stan">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/projpred/">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://discourse.mc-stan.org/">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="quickstart_glmm_files/header-attrs-2.3/header-attrs.js"></script><script src="quickstart_glmm_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>projpred Performing variable and structure selection on Generalized Linear Multilevel Models</h1>
            
            <h4 class="date">2020-10-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/stan-dev/projpred/blob/master/vignettes/quickstart_glmm.Rmd"><code>vignettes/quickstart_glmm.Rmd</code></a></small>
      <div class="hidden name"><code>quickstart_glmm.Rmd</code></div>

    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{projpred Performing variable and structure selection on Generalized Linear Multilevel Models}
\usepackage[utf8](inputenc)
-->
<p><strong>This vignette requires the projpred version currently available in master branch at <a href="https://github.com/stan-dev/projpred" class="uri">https://github.com/stan-dev/projpred</a></strong></p>
<p>This vignette shows how to use <code>projpred</code> to perform variable selection in the context of Generalized Linear Multilevel Models (GLMMs). For a general overview of the package we refer the reader to the quickstart vignette. The method used here is described in the latest preprint (<a href="http://arxiv.org/abs/2010.06994">Catalina et al. 2020</a>).</p>
<div id="gaussian-example" class="section level2">
<h2 class="hasAnchor">
<a href="#gaussian-example" class="anchor"></a>Gaussian example</h2>
<p>Load the necessary packages. If the sampling takes more than 30 seconds and multiple cores are available, uncomment the line setting <code>mc.cores</code> to set the number of cores used (this is commented out as the sampling in the example is fast and to avoid possible problems when building the vignette along the package installation in special environments such as computing clusters).</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/projpred">projpred</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstanarm/">rstanarm</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot">bayesplot</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#options(mc.cores = 4)</span></pre></div>
<p>For the first Gaussian example we borrow the popular <code>orthodont</code> dataset from the <code>nlme</code> package. This data include observations from a growth curve on an orthodontic measurement. It contains 108 observations with 4 variables. The variables contained in this dataset are:</p>
<ul>
<li>distance, numeric distances from the pituitary to the pterygomaxillary fissure (mm). These are measured on x-ray images of the skull.</li>
<li>age, the age of the subject (years).</li>
<li>Subject, an ordered factor indicating the subject on which the measurement is taken.</li>
<li>Sex, indicator of sex in the subject.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"Orthodont"</span>, package <span class="op">=</span> <span class="st">"nlme"</span><span class="op">)</span></pre></div>
<p>We first build the following complete <code>rstanarm</code> model including all variables:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">stan_glmer</span><span class="op">(</span><span class="va">distance</span> <span class="op">~</span> <span class="va">age</span> <span class="op">*</span> <span class="va">Sex</span> <span class="op">+</span> <span class="op">(</span><span class="va">age</span> <span class="op">|</span> <span class="va">Subject</span><span class="op">)</span>,
                  chains <span class="op">=</span> <span class="fl">2</span>,  data <span class="op">=</span> <span class="va">Orthodont</span>, seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></pre></div>
<p>Since we have repeated measurements over subjects at multiple time points, the effect of <code>age</code> is allowed to vary over subjects. To run <code>projpred</code> on this model we can first run a simple variable selection with the full dataset. This approach may be overconfident in some cases and therefore in general cases it is recommended to run a cross validated variable selection.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/varsel.html">varsel</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></pre></div>
<p>Because our model includes group effects, the only available search method is forward search, which is a bit slower than L_1 search but is quite accurate. Beware that the underlying projection fitting method could return some warnings in cases where the optimization may not have converged properly. This is more common in the case of generalized models (non-Gaussian families). We print the list of the variables ordered by relevance:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu">solution_terms</span><span class="op">(</span><span class="va">vs</span><span class="op">)</span> <span class="co"># selection order of the variables</span></pre></div>
<pre><code>## [1] "(1 | Subject)"   "age"             "(age | Subject)" "Sex"            
## [5] "age:Sex"</code></pre>
<p>We plot some statistics computed on the training data, such as the sum of log predictive densities (ELPD) and root mean squared error (RMSE) as the function of number of variables added. By default, the statistics are shown on absolute scale, but with <code>deltas = TRUE</code> the plot shows results relative to the full model.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="co"># plot predictive performance on training data</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">vs</span>, stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'elpd'</span>, <span class="st">'rmse'</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="quickstart_glmm_files/figure-html/unnamed-chunk-7-1.png" width="480"></p>
<p>From this plot, it is clearly visible that the first two terms are probaly enough to achieve predictive performance comparable to the reference model. We perform the projection for a submodel of desired size using the function <code>project</code>. The projection can also be coerced to a matrix with draws of the selected variables and sigma. The draws can be visualized with, for example, the <code>mcmc_areas</code> function in the <code>bayesplot</code> package. Below we compare how the projection affects the three most relevant variables.</p>
<!-- ```{r, fig.width=6, fig.height=2} -->
<!--  # Visualise the three most relevant variables in the full model -\-> -->
<!--  mcmc_areas(as.matrix(vs$refmodel$fit), -->
<!--             pars = c("(Intercept)", "Subject__Intercept", "age", -->
<!--                      "sd_Subject__age", "sigma")) -->
<!-- ``` -->
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="co"># Visualise the projected three most relevant variables</span>
<span class="va">proj</span> <span class="op">&lt;-</span> <span class="fu">project</span><span class="op">(</span><span class="va">vs</span>, nterms <span class="op">=</span> <span class="fl">2</span>, ns <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-intervals.html">mcmc_areas</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">proj</span><span class="op">)</span>, pars <span class="op">=</span> <span class="fu">solution_terms</span><span class="op">(</span><span class="va">vs</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></pre></div>
<p><img src="quickstart_glmm_files/figure-html/unnamed-chunk-8-1.png" width="576"></p>
<p>We make predictions with the projected submodels. For point estimates we can use method <code>proj_linpred</code>. Test inputs can be provided using the keyword <code>newdata</code>. If also the test targets <code>ynew</code> are provided, then the function evaluates the log predictive density at these points. For instance, the following computes the mean of the predictive distribution and evaluates the log density at the training points using the 5 most relevant variables.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/proj-pred.html">proj_linpred</a></span><span class="op">(</span><span class="va">vs</span>, newdata <span class="op">=</span> <span class="va">Orthodont</span>, nterms <span class="op">=</span> <span class="fl">5</span>, integrated <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<p>Visualize the predictions</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">pred</span><span class="op">$</span><span class="va">pred</span>, y <span class="op">=</span> <span class="va">Orthodont</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"prediction"</span>, y <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span></pre></div>
<p><img src="quickstart_glmm_files/figure-html/unnamed-chunk-10-1.png" width="480"></p>
<p>We also obtain draws from the projected predictive distribution. Here’s an example prediction for a random data point using 5 terms (the observed value is marked by the red line).</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="va">subset</span> <span class="op">&lt;-</span> <span class="va">Orthodont</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html">sample_n</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">y_subset</span> <span class="op">&lt;-</span> <span class="va">subset</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">distance</span><span class="op">)</span>
<span class="va">y1_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/proj-pred.html">proj_predict</a></span><span class="op">(</span><span class="va">vs</span>, newdata <span class="op">=</span> <span class="va">subset</span>, nterms <span class="op">=</span> <span class="fl">5</span>, seed <span class="op">=</span> <span class="fl">7560</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/qplot.html">qplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">y1_rep</span><span class="op">)</span>, bins <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">y_subset</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"y1_rep"</span><span class="op">)</span></pre></div>
<p><img src="quickstart_glmm_files/figure-html/unnamed-chunk-11-1.png" width="480"></p>
</div>
<div id="poisson-example" class="section level2">
<h2 class="hasAnchor">
<a href="#poisson-example" class="anchor"></a>Poisson example</h2>
<p>In this case we will download count data from the web,</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="va">data_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"data_pois.csv"</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<p>These data correspond to a phylogenetic dataset where the phenotype is expressed as counts. This kind of data is relevant in evolutionary biology when data of many species are analyzed at the same time. The model we fit here is borrowed from <em>Modern Phylogenetic Comparative Methods and the application in Evolutionary Biology</em> (de Villemeruil &amp; Nakagawa, 2014). The necessary data can also be downloaded from the corresponding website (<a href="http://www.mpcm-evolution.com/" class="uri">http://www.mpcm-evolution.com/</a>). The model is taken from the <em>Estimating Phylogenetic Multilevel Models with brms</em> vignette of the brms package (<a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_phylogenetics.html" class="uri">https://cran.r-project.org/web/packages/brms/vignettes/brms_phylogenetics.html</a>).</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">stan_glmer</span><span class="op">(</span>
  <span class="va">phen_pois</span> <span class="op">~</span> <span class="va">cofactor</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">phylo</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">obs</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data_pois</span>,
  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">poisson</a></span><span class="op">(</span><span class="st">"log"</span><span class="op">)</span>, chains <span class="op">=</span> <span class="fl">2</span>, iter <span class="op">=</span> <span class="fl">2000</span>,
  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>
<span class="op">)</span></pre></div>
<p>As we did in the previous example, we can perform variable selection and look at the projection.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="va">vs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/varsel.html">varsel</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></pre></div>
<p>Because our model includes group effects, the only available search method is forward search, which is a bit slower than L_1 search but is quite accurate. Beware that the underlying projection fitting method could return some warnings in cases where the optimization may not have converged properly. This is more common in the case of generalized models (non-Gaussian families). We print the list of the variables ordered by relevance:</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="fu">solution_terms</span><span class="op">(</span><span class="va">vs</span><span class="op">)</span> <span class="co"># selection order of the variables</span></pre></div>
<pre><code>## [1] "cofactor"    "(1 | phylo)" "(1 | obs)"</code></pre>
<p>We plot some statistics computed on the training data, such as the sum of log predictive densities (ELPD) and root mean squared error (RMSE) as the function of number of variables added. By default, the statistics are shown on absolute scale, but with <code>deltas = TRUE</code> the plot shows results relative to the full model.</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="co"># plot predictive performance on training data</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">vs</span>, stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'elpd'</span>, <span class="st">'rmse'</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="quickstart_glmm_files/figure-html/unnamed-chunk-16-1.png" width="480"></p>
<p>We perform the projection for a submodel of desired size using the function <code>project</code>. The projection can also be coerced to a matrix with draws of the selected variables and sigma. The draws can be visualized with, for example, the <code>mcmc_areas</code> function in the <code>bayesplot</code> package. Below we compare how the projection affects the most relevant variables.</p>
<!-- ```{r, fig.width=6, fig.height=2} -->
<!--  # Visualise the most relevant variable in the full model -\-> -->
<!--  mcmc_areas(as.matrix(vs$refmodel$fit), -->
<!--             pars = c("b_Intercept", "b_cofactor", "sd_phylo__Intercept")) -->
<!-- ``` -->
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="co"># Visualise the projected two most relevant variables</span>
<span class="va">proj</span> <span class="op">&lt;-</span> <span class="fu">project</span><span class="op">(</span><span class="va">vs</span>, nterms <span class="op">=</span> <span class="fl">2</span>, ndraws <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-intervals.html">mcmc_areas</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">proj</span><span class="op">)</span>, pars <span class="op">=</span> <span class="fu">solution_terms</span><span class="op">(</span><span class="va">vs</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></pre></div>
<p><img src="quickstart_glmm_files/figure-html/unnamed-chunk-17-1.png" width="576"></p>
<p>As we did in the Gaussian example, we make predictions with the projected submodels. The following computes the mean of the predictive distribution and evaluates the log density at the training points using the previously projected model.</p>
<div class="sourceCode" id="cb19"><pre class="downlit">
<span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/proj-pred.html">proj_linpred</a></span><span class="op">(</span><span class="va">proj</span>, newdata <span class="op">=</span> <span class="va">data_pois</span>, integrated <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<p>We can also visualize the corresponding projected predictions.</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="va">xaxis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">3</span>, length.out <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>
<span class="va">y_mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span><span class="op">(</span><span class="va">vs</span><span class="op">$</span><span class="va">refmodel</span><span class="op">$</span><span class="va">mu</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">pred</span><span class="op">$</span><span class="va">pred</span>, y <span class="op">=</span> <span class="va">y_mu</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">xaxis</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">xaxis</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"prediction"</span>, y <span class="op">=</span> <span class="st">"y"</span><span class="op">)</span></pre></div>
<p><img src="quickstart_glmm_files/figure-html/unnamed-chunk-19-1.png" width="480"></p>
</div>
<div id="bernoulli-example" class="section level2">
<h2 class="hasAnchor">
<a href="#bernoulli-example" class="anchor"></a>Bernoulli example</h2>
<p>For both of the previous cases, running variable selection with the full data was actually enough because they were pretty simple. In this section we work on a slightly more complex data set.</p>
<p>We can load the data from the popular <code>lme4</code> package:</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"VerbAgg"</span>, package <span class="op">=</span> <span class="st">"lme4"</span><span class="op">)</span></pre></div>
<p>The whole dataset consists of 7584 questionnaire answers from different subjects. Given that the full data could take a long time to fit, we will subsample 50 individuals (for which sampling still takes a bit). For this, we use the great <code>tidyverse</code> environment.</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="co">## subsample 50 participants</span>
<span class="va">VerbAgg_subsample</span> <span class="op">&lt;-</span> <span class="va">VerbAgg</span> <span class="op">%&gt;%</span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">id</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>r2num <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">r2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># binomial family needs numeric target</span></pre></div>
<p>For this simple model we will add some group effects that we know are not quite relevant.</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="co">## simple bernoulli model</span>
<span class="va">formula_va</span> <span class="op">&lt;-</span> <span class="va">r2num</span> <span class="op">~</span> <span class="va">btype</span> <span class="op">+</span> <span class="va">situ</span> <span class="op">+</span> <span class="va">mode</span> <span class="op">+</span> <span class="op">(</span><span class="va">btype</span> <span class="op">+</span> <span class="va">situ</span> <span class="op">+</span> <span class="va">mode</span> <span class="op">|</span> <span class="va">id</span><span class="op">)</span>
<span class="va">fit_va</span> <span class="op">&lt;-</span> <span class="fu">stan_glmer</span><span class="op">(</span>
  formula <span class="op">=</span> <span class="va">formula_va</span>,
  data <span class="op">=</span> <span class="va">VerbAgg_subsample</span>,
  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span><span class="st">"logit"</span><span class="op">)</span>,
  seed <span class="op">=</span> <span class="fl">1234</span>,
  chains <span class="op">=</span> <span class="fl">2</span>
<span class="op">)</span></pre></div>
<p>As we did before, we can run the standard variable selection with</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="va">vs_va</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/varsel.html">varsel</a></span><span class="op">(</span><span class="va">fit_va</span><span class="op">)</span></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="fu">solution_terms</span><span class="op">(</span><span class="va">vs_va</span><span class="op">)</span></pre></div>
<pre><code>## [1] "(1 | id)"     "btype"        "situ"         "(situ | id)"  "(btype | id)"
## [6] "mode"         "(mode | id)"</code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">vs_va</span>, stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"elpd"</span>, <span class="st">"acc"</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="quickstart_glmm_files/figure-html/unnamed-chunk-25-1.png" width="480"></p>
<p>Even though the ordering of the variables makes sense, the performance of the projected models does not quite match the reference model. There may be different reasons that can explain this behaviour:</p>
<ol style="list-style-type: decimal">
<li>The reference model posterior may not be very narrow and then running <code>varsel</code> with the default <code>ndraws_pred</code> could be not enough. Increasing <code>ndraws_pred</code> helps but also increases the computational cost. Re fitting the reference model ensuring a narrower posterior (usually employing a stronger sparsifying prior) would have a similar effect. This is usually the case when the difference in predictive performance is not very large.</li>
<li>For non-Gaussian models the source of the inaccuracy may come from the fact that we are running an approximate projection. In this case, increasing the number of draws for the prediction <code>ndraws_pred</code> should also help.</li>
<li>Given that <code>varsel</code> computes the expected predictive performance of the reference model from the in-sample mean, it may sometimes result in overconfident results. Running <code>cv_varsel</code> with LOO cross validation computes the predictive performance by taking PSIS-LOO weights into account, usually reporting a more realistic ELPD.</li>
</ol>
<p>By default, <code>cv_varsel</code> will run LOO cross validation, and will try to run a full variable selection for every data point. We will not run it in this vignette for computational reasons, but it is always recommended to run the full CV procedure. Nonetheless, running <code>varsel</code> first can offer a first idea of the performance of the projections. Cross-validated selection procedure can be run with <code><a href="../reference/cv_varsel.html">cv_varsel(object, cv_method = "loo", nloo = ..., K = ...)</a></code> with a similar API as <code>varsel</code>. <!-- Given the large computational cost of running more draws, we'll first try running `cv_varsel` without validating the search.  --> <!-- We can omit this behaviour by fitting the model once and computing the LOO elpd posterior from it by passing the argument `validate_search = FALSE`.  --> <!-- Note that in general it is recommended to run the full validation --> <!-- search. --></p>
<!-- ```{r, cache=TRUE, results="hide", message=FALSE, warning=FALSE} -->
<!-- cv_vs_va <- cv_varsel(fit_va, validate_search = FALSE) -->
<!-- ``` -->
<!-- ```{r, fig.height=4, fig.width=5} -->
<!-- plot(cv_vs_va, stats = c("elpd", "acc")) -->
<!-- ``` -->
<!-- Now we see that the projected models behave as expected and can proceed with the -->
<!-- usual analysis. -->
<!-- As in previous examples, we can show the mean prediction with `proj_linpred`. -->
<!-- The following computes the mean of the predictive distribution and evaluates the -->
<!-- log density at the training points using the 6 most relevant variables. -->
<!-- ```{r, cache=TRUE, message=FALSE, warning=FALSE} -->
<!-- pred <- proj_linpred(cv_vs_va, newdata = VerbAgg_subsample, -->
<!--                      nterms = 6, integrated = TRUE, ndraws = 10) -->
<!-- ``` -->
<!-- We can also visualize the corresponding projected predictions. -->
<!-- ```{r, fig.width=5, fig.height=3} -->
<!-- xaxis <- seq(-6, 6, length.out = 1000) -->
<!-- yaxis <- cv_vs_va$family$linkinv(xaxis) -->
<!-- y_mu <- rowMeans(cv_vs_va$refmodel$mu) -->
<!-- ggplot() + -->
<!--   geom_point(aes(x = pred$pred, y = y_mu)) + -->
<!--   geom_line(aes(x = xaxis, y = yaxis), color = "red") + -->
<!--   labs(x = "prediction", y = "y") -->
<!-- ``` -->
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Juho Piironen, Markus Paasiniemi, Alejandro Catalina, Aki Vehtari.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
